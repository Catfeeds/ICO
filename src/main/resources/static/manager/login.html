<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>kikoico</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="bookmark" href="../static/assets/images/favicon.ico" type="image/x-icon">
  <link rel="shortcut icon" href="../static/assets/images/favicon.ico">
  <link rel="stylesheet" href="bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.5.0/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/AdminLTE.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="plugins/iCheck/square/blue.css">
  <link rel="stylesheet" href="css/sweet-alert.css">
  <script src="scripts/sweet-alert.js"></script>
  <script src="scripts/app.js"></script>

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="hold-transition login-page" style="height: auto">
<div class="login-box">
  <div class="login-logo">
    <a href="/manager/login.html"><b>管理员登录</b></a>
  </div>
  <!-- /.login-logo -->
  <div class="login-box-body">
    <p class="login-box-msg">登录开启您的旅程</p>

    <form>
      <div class="form-group has-feedback">
        <input type="text" class="form-control" placeholder="userName" id="userName">
        <span class="glyphicon glyphicon-user form-control-feedback"></span>
      </div>
      <div class="form-group has-feedback">
        <input type="password" class="form-control" placeholder="password" id="password">
        <span class="glyphicon glyphicon-lock form-control-feedback"></span>
      </div>
      <div class="row">
        <div class="col-xs-8">
          <div class="checkbox icheck">
            <!--<label>-->
              <!--<input type="checkbox"> 记住密码-->
            <!--</label>-->
          </div>
        </div>
        <!-- /.col -->
        <div class="col-xs-4">
          <button type="button" class="btn btn-primary btn-block btn-flat" id="login">登录</button>
        </div>
        <!-- /.col -->
      </div>
    </form>
    <a href="#formModal" data-toggle="modal" data-target="#formModal">忘记密码？</a><br>
  </div>
  <!-- /.login-box-body -->
  <div class="modal fade" id="formModal" tabindex="-1" role="dialog"
       aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"
                  aria-hidden="true"></button>
          <h4 class="modal-title" style="font-size:14px;">忘记密码</h4>
        </div>
        <form id="form_first" class="form-horizontal mb-lg">
          <div class="modal-body">
            <div class="form-group">
              <label class="col-sm-4 control-label">邮箱</label>
              <div class="col-sm-6">
                <input type="text" id="firstemail"
                       placeholder="请输入您的邮箱"
                       class="form-control"/>
              </div>
              <div class="col-sm-2"></div>
            </div>

            <div class="form-group">
              <label class="col-sm-4 control-label">手机号码</label>
              <div class="col-sm-6">
                <input type="text" id="firstphone"
                       class="form-control"
                       placeholder="请输入您的手机号码"/>
              </div>
              <div class="col-sm-2"></div>
            </div>
            <div class="form-group" id="resultdiv"
                 style="display:none;">
              <div class="col-sm-12" style="text-align: center;">
                <label style="color:#4f4a9c;"
                       id="resultlable"></label>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <input type="button" class="cs-bgcolor btn btn-primary"
                   style="color: #ffffff; font-weight: bold;"
                   data-toggle="modal"
                   value="下一步" id="nextstep"/>
            <input type="button" class="cs-bgcolor btn btn-primary"
                   style="color: #ffffff; font-weight: bold;display: none;"
                   data-toggle="modal"
                   value="提交" id="submit"/>
          </div>
        </form>
      </div>
    </div>
  </div>



</div>
<!-- /.login-box -->

<!-- jQuery 2.2.3 -->
<script src="plugins/jQuery/jquery-2.2.3.min.js"></script>
<!-- Bootstrap 3.3.6 -->
<script src="bootstrap/js/bootstrap.min.js"></script>
<!-- iCheck -->
<script src="plugins/iCheck/icheck.min.js"></script>
<script src="scripts/sweet-alert.js"></script>
<script src="scripts/jwt-decode.min.js"></script>
<script src="scripts/app.js"></script>
<script>
  $(function () {
    $('input').iCheck({
      checkboxClass: 'icheckbox_square-blue',
      radioClass: 'iradio_square-blue',
      increaseArea: '20%' // optional
    });
  });
  jQuery(window).load(function () {
      $("#login").click(function () {
          var userName = $("#userName").val();
          var password = $("#password").val();
          if (userName.length <= 0) {
              app.myAlert("登录名", "登录名不能为空！", "warning");
              userName.focus();
              return false;
          }
          if (password.length <= 0) {

              app.myAlert("密码", "密码不能为空！", "warning");
              password.focus();
              return false;
          }
          var userjson = {emailAccount: userName, password: password};
          $.ajax({
              url: app.getServerUrl()+"/auth/adminLogin",
              type: 'POST',
              timeout: 10000,//超时时间设置为10秒；
              data: JSON.stringify(userjson),
              dataType: 'json',//服务器返回json格式数据
              contentType: "application/json; charset=utf-8",
              success: function (result) {
                  if (result.code == 200) {
                      app.setUserInfo(result.data.userInfo);
                      app.setToken(result.data.token);
                      location.href = "./index.html";
                  } else {
                      app.myAlert("", result.message, "warning");
                  }
              },
              error: function (xhr, type, errerThrown) {
                  app.myAlert("", "网络异常,请稍候再试!", "error");
              }
          });
      });
  });
  document.onkeydown=function(event){
      var e = event || window.event || arguments.callee.caller.arguments[0];
      if(e && e.keyCode==13){ // enter 键
          setTimeout(function(){
              $("#login").click();
          },0)
      }
  }



  // 下一步按钮
  $("#nextstep").click(function () {
      var firstEmail = $("#firstemail").val();
      var firstPhone = $("#firstphone").val();
      if (!firstEmail) {
          $("#resultlable").text("邮箱不可为空!");
          $("#resultdiv").show();
          return;
      }
      if (!firstPhone) {
          $("#resultlable").text("手机号码不可为空!");
          $("#resultdiv").show();
          return;
      }
      $.ajax({
          url: app.getServerUrl() + "/auth/userExist/" + firstEmail + "&" + firstPhone,
          type: 'GET',
          timeout: 10000,//超时时间设置为10秒；
          dataType: 'json',//服务器返回json格式数据
          contentType: "application/json; charset=utf-8",
          success: function (result) {
              if (result.code == 200) {
                  app.setUserInfo(result.data.userInfo);
//                    $('#nextstep').attr("data-target","#subformModal");
                  $('.modal-body').empty();
                  $('.modal-body').append("<div class='form-group mt-lg'>"+
                      "<label class='col-sm-2 control-label'>邮箱</label>"+
                      "<div class='col-sm-6'><input type='text' id='secondemail' class='form-control' readonly='readonly'/></div>"+
                      "<div class='col-sm-4'></div></div><div class='form-group mt-lg'><label class='col-sm-2 control-label'>手机号码</label>"+
                      "<div class='col-sm-6'><input type='text' id='mobile' class='form-control' readonly='readonly'/></div>"+
                      "<div class='col-sm-4'></div></div><div class='form-group'><label class='col-sm-2 control-label'>验证码</label>"+
                      "<div class='col-sm-3'><input type='text' id='verifycode' class='form-control' style='width:140px;' maxlength='6'/>"+
                      "</div><div class='col-sm-7'>" +
                      "<input type='button' id='sendsms' class='cs-bgcolor btn btn-primary'style='color: #ffffff; font-weight: bold;'value='发送手机验证码'/>"+
                      "</div></div><div class='form-group'><label class='col-sm-2 control-label'>新密码</label>"+
                      "<div class='col-sm-6'><input type='password' id='newpass' class='form-control' style='width:140px;'/>"+
                      "</div><div class='col-sm-4'></div></div><div class='form-group'><label class='col-sm-2 control-label'>确认新密码</label>"+
                      "<div class='col-sm-6'><input type='password' id='renewpass' class='form-control'style='width:140px;'/></div>"+
                      "<div class='col-sm-4'></div></div><div class='form-group' id='resultdiv2' style='display: none;'>"+
                      "<div class='col-sm-12' style='text-align: center;'><label style='color:#4f4a9c;' id='resultlable2'></label></div></div>");
                  $('#nextstep').hide();
                  $('#submit').show();
                  $("#secondemail").val(firstEmail);
                  $("#mobile").val(firstPhone);
              }
              else {
                  $("#resultlable").text(result.message);
                  $("#resultdiv").css("display", "block");
                  return;
              }
          },
          error: function (xhr, type, errerThrown) {
              $("#resultlable").text("网络异常，请重试!");
              $("#resultdiv").css("display", "block");
              return;
          }
      });
  });

  // 取消button绑定事件
  $("#cancle").click(function () {
      window.location.reload();
  });
  //给发送验证码按钮绑定监听事件
  $("#sendsms").click(function () {
      var phoneNum = $("#mobile").val();
      var phoneJson = {"phone": phoneNum, "id": app.getUserInfo().id};
      // 此处调用发送手机验证码的接口获取手机验证码
      $.ajax({
          url: app.getServerUrl() + "/auth/validatePhone",
          type: 'POST',
          timeout: 10000,//超时时间设置为10秒；
          data: JSON.stringify(phoneJson),
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          success: function (result) {
              if (result.code == 200) {
                  app.setUserInfo(result.data.userInfo);
                  $("#resultlable2").text(result.message);
                  $("#resultdiv2").css("display", "block");
              }
              else {
                  $("#resultlable2").text(result.message);
                  $("#resultdiv2").css("display", "block");
                  return;
              }
          },
          error: function (xhr, type, errerThrown) {
              $("#resultlable2").text("网络异常，请重试!");
              $("#resultdiv2").css("display", "block");
              return;
          }
      });
  });



  //提交按钮触发事件
  $("#submit").click(function () {
      // 验证重置密码
      var newPass = $("#newpass").val();
      var renewPass = $("#renewpass").val();
      var verifycode = $("#verifycode").val();
      if (verifycode.length <= 0) {
          app.myAlertWithoutFunction(" ", "验证码不能为空!", "warning");
          return;
      }
      if (verifycode != app.getUserInfo().verifyCode) {
          app.myAlertWithoutFunction("", "验证码信息错误，请重新输入!", "error");
          return;
      } else if (app.getUserInfo().expireDate < new Date()) {
          app.myAlertWithoutFunction("", "验证码已过期，请重新发送！", "warning");
          return;
      } else {
          if (newPass.lenth < 8 || newPass.lenth > 30) {
              $("#resultlable2").text("密码需为8位以上,30位以下!");
              $("#resultdiv2").css("display", "block");
              return;
          }
          if (newPass != renewPass) {
              $("#resultlable2").text("两次输入的密码不一致!");
              $("#resultdiv2").css("display", "block");
              return;
          }
          var forgetPassword = {"password": newPass, "id": app.getUserInfo().id};
          // 此处调用发送手机验证码的接口获取手机验证码
          $.ajax({
              url: app.getServerUrl() + "/auth/forgetPassword",
              type: 'PUT',
              timeout: 10000,//超时时间设置为10秒；
              contentType: "application/json; charset=utf-8",
              data: JSON.stringify(forgetPassword),
              dataType: "json",
              success: function (result) {
                  if (result.code == 200) {
                      app.setUserInfo(result.data.userInfo);
                      app.myAlert("", "重置密码成功!", "success", "sign.html");
                  }
                  else {
                      $("#resultlable2").text(result.message);
                      $("#resultdiv2").css("display", "block");
                      return;
                  }
              },
              error: function (xhr, type, errerThrown) {
                  $("#resultlable2").text("网络异常,请稍候再试!");
                  $("#resultdiv2").css("display", "block");
                  return;
              }
          });
      }
      time(this);
  });
  var wait = 60;
  function time(obj) {
      $this = $(obj);
      if (wait === 0) {
          $this.removeAttr("disabled").val("发送手机验证码");
          wait = 60;
      } else {
          $this.attr("disabled", true).val("重新发送(" + wait + ")");
          wait--;
          setTimeout(function () {
              time(obj)
          }, 1000)
      }
  }
</script>
</body>
</html>
